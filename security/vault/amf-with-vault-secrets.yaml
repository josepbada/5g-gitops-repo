# AMF deployment that retrieves secrets from Vault
# Uses Vault Agent Injector to automatically inject secrets into the pod
apiVersion: apps/v1
kind: Deployment
metadata:
  name: amf-with-vault
  namespace: telco-core
  labels:
    app: 5g-core
    component: amf
    secrets: vault
spec:
  replicas: 1
  selector:
    matchLabels:
      app: 5g-core
      component: amf
  template:
    metadata:
      labels:
        app: 5g-core
        component: amf
      # Vault annotations tell the injector to inject secrets
      annotations:
        # Enable Vault agent injection
        vault.hashicorp.com/agent-inject: "true"
        # Vault address
        vault.hashicorp.com/role: "amf"
        # Inject auth-server credentials
        vault.hashicorp.com/agent-inject-secret-auth-server: "secret/data/amf/auth-server"
        vault.hashicorp.com/agent-inject-template-auth-server: |
          {{- with secret "secret/data/amf/auth-server" -}}
          export AUTH_USERNAME="{{ .Data.data.username }}"
          export AUTH_PASSWORD="{{ .Data.data.password }}"
          export AUTH_ENDPOINT="{{ .Data.data.api_endpoint }}"
          {{- end }}
        # Inject database credentials
        vault.hashicorp.com/agent-inject-secret-database: "secret/data/amf/database"
        vault.hashicorp.com/agent-inject-template-database: |
          {{- with secret "secret/data/amf/database" -}}
          export DB_HOST="{{ .Data.data.db_host }}"
          export DB_USER="{{ .Data.data.db_user }}"
          export DB_PASSWORD="{{ .Data.data.db_password }}"
          {{- end }}
    spec:
      serviceAccountName: amf-operator
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 2000
      containers:
      - name: amf
        image: nginx:1.24-alpine
        securityContext:
          runAsNonRoot: true
          runAsUser: 1000
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: true
        command: ["/bin/sh"]
        args:
          - -c
          - |
            echo "AMF Starting with Vault secrets..."
            # In real AMF, you would source the secret files
            # For demo, we'll just show they exist
            if [ -f /vault/secrets/auth-server ]; then
              echo "Auth server credentials loaded"
              cat /vault/secrets/auth-server
            fi
            if [ -f /vault/secrets/database ]; then
              echo "Database credentials loaded"
              cat /vault/secrets/database
            fi
            # Start nginx (simulating AMF service)
            nginx -g 'daemon off;'
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: cache
          mountPath: /var/cache/nginx
        - name: run
          mountPath: /var/run
      volumes:
      - name: tmp
        emptyDir: {}
      - name: cache
        emptyDir: {}
      - name: run
        emptyDir: {}